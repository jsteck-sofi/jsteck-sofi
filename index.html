<script>

  /**
   * Helper to communicate with sofi from within an iframe.
   * 
   * @example
   * sofiApi.sendAddress("123 Post St, Santa Clara, CA, 94507");
   * sofiApi.sendEstimatedCost(29241.43);
   * sofiApi.sendContinueApp();
   * sofiApi.sendError("Could not do thing");
   */
  const sofiApi = {
    _allowedOrigins: [
      "https://www.sofi.com",
      /^https:\/\/kraken-dev-\d+\.sofitest\.com$/, // e.g. https://kraken-dev-23.sofitest.com/
    ],
    _isListening: false,
    _startListening() {
      if (sofiApi._isListening) return; // called multiple times?
      sofiApi._isListening = true;

      window.addEventListener('message', event => {
        // If any of the allowedOrigins connect to us
        if (sofiApi._allowedOrigins.some(o => event.origin.match(o))) {
          if (event.data.type === "START") {
            sofiApi._source = event.source;
            sofiApi._origin = event.origin;
            // Reply with confirmation
            event.source.postMessage({ type: 'CONFIRM_START' }, sofiApi._origin);
            sofiApi._sendQueuedMessages();
          }
        } else {
            // The data was not sent from an allowedOrigin.
            return; 
        }
      });
    },
    _source: null, // our parent frame that we're talking with
    _origin: null, // origin of our parent frame that we're talking with
    _toSend: [], // queue of messages to send when we connect to the parent
    _send(obj) {
      // Keep a list of all the things to send in case we don't have a connection yet.
      sofiApi._toSend.push(obj);

      if (!sofiApi._isListening) {
        throw new Error("Must call sofiApi._startListening() when the page loads and before we send anything.");
      }

      sofiApi._sendQueuedMessages();
    },
    _sendQueuedMessages() {
      if (sofiApi._source && sofiApi._origin) {
        // Send all queued messages
        while (sofiApi._toSend.length > 0) {
          sofiApi._source.postMessage(sofiApi._toSend[0], sofiApi._origin);
          sofiApi._toSend.shift(); // remove the object we sent
        }
      }
    },
    // ----------------------- Methods to Send info ----------------------- //
    // All data sent follows the { type: string, payload: any } format.

    // Ideally, this information gets sent as soon as it is known. It's
    //   okay to send any piece of info multiple times in case of changes.

    // e.g. sofiApi.sendAddress('123 Post St, Santa Clara, CA, 94507');
    sendAddress(addressString) {
      sofiApi._send({
        type: 'ADDRESS',
        payload: addressString,
      });
    },
    // sofiApi.sendEstimatedCost(29241.43);
    sendEstimatedCost(costFloat) {
      sofiApi._send({
        type: 'ESTIMATED_COST',
        payload: costFloat,
      });
    },
    // sofiApi.sendContinueApp();
    sendContinueApp() {
      sofiApi._send({
        type: 'CONTINUE_APP',
      });
    },
    // sofiApi.sendError("Could not find address");
    sendError(errorString) {
      sofiApi._send({
        type: 'ERROR',
        payload: errorString,
      });
    },
  };
  sofiApi._startListening(); // called asap

</script>

<h1>
  IFrame Api Example
</h1>

<div>
  <input id="inputAddress" value="123 abc" /> <button id="btnAddress">Send Address</button>
</div>
<div>
  <input id="inputEstimatedCost" value="567.30" /> <button id="btnEstimatedCost">Send EstimatedCost</button>
</div>
<div>
  <input id="inputContinueApp" disabled /> <button id="btnContinueApp">Send ContinueApp</button>
</div>
<div>
  <input id="inputError" value="big problem" /> <button id="btnError">Send Error</button>
</div>

<script>
  btnAddress.onclick = () => sofiApi.sendAddress(window.inputAddress.value);
  btnEstimatedCost.onclick = () => sofiApi.sendEstimatedCost(parseFloat(window.inputEstimatedCost.value));
  btnContinueApp.onclick = () => sofiApi.sendContinueApp();
  btnError.onclick = () => sofiApi.sendError(window.inputError.value);
</script>
